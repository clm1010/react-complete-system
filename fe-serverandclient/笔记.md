
# 服务器端 (Server Component, Server Action) 和 客户端 (Client Component) 使用场景

## 以下是核心的指导原则和常见场景：

### 直接调用 services 层 (绕过 app/api 路由)

主要场景: 当你的代码已经在 Next.js 服务器端安全运行，并且需要与你的后端数据库或外部 API 进行交互时。

Server Components (app/.../page.tsx, app/.../layout.tsx, 或其他默认组件):

用途: 获取页面初始渲染所需的数据。
原因: Server Components 在服务器上执行。直接调用 services 层获取数据是最直接、最高效的方式，避免了不必要的内部网络跳转 (Server Component -> Service -> Backend 比 Server Component -> /api Route -> Service -> Backend 更快)。
示例: 在 app/page.tsx 中 await questionnaireService.getQuestionnaires() 来获取首页列表。
Server Actions (app/actions/....ts):

用途: 处理表单提交、按钮点击等触发的数据变更操作（增删改）。
原因: Server Actions 也在服务器上执行。直接调用 services 层执行数据库操作或调用后端 API 是最自然、最高效的方式。
示例: 在 submitQuestionnaire Action 中调用 questionnaireService.createQuestionnaire(data)。
2. 调用 app/api 路由

主要场景: 当你需要一个标准的 HTTP 端点来处理请求时，通常是因为请求发起方不在 Next.js 服务器的安全环境中，或者你需要一个明确的 API 接口。

Client Components ('use client' 组件):

用途: 在浏览器中进行交互式的数据获取或更新（例如，用户点击按钮后获取详情、实现搜索建议、轮询更新、使用 SWR/React Query 等数据获取库）。
原因:
安全/抽象: 客户端代码运行在浏览器中，直接调用外部后端 API 可能暴露敏感信息（如后端 URL、API 密钥），并且需要处理复杂的 CORS 和认证问题。调用相对路径的 Workspace('/api/...') 更安全、更简单，将复杂性封装在服务器端的 API 路由中。
BFF (Backend for Frontend): API 路由可以作为前端的后端，专门为客户端组件的需求定制数据格式或聚合来自多个服务的数据。
简化客户端逻辑: API 路由可以处理认证、缓存等逻辑，让客户端组件更专注于 UI。
示例: 我们添加的 QuestionnaireListApiClient 组件通过 Workspace('/api/questionnaires') 获取数据。
外部消费者 (Third-Party Applications):

用途: 为你的移动 App、其他微服务或第三方合作伙伴提供一个可以调用的 API 接口。
原因: app/api 路由提供了标准的 HTTP 端点，这是构建公共或私有 API 的标准方式。外部服务无法直接调用你的 services 层函数。
示例: 提供 GET /api/public/stats 给外部仪表盘使用。
Webhooks:

用途: 接收来自外部服务（如支付平台 Stripe、代码托管平台 GitHub）的事件通知。
原因: Webhook 需要一个公开可访问的 HTTP POST (或其他方法) 端点来接收数据。app/api 路由是实现这一点的理想选择。路由处理程序会接收 webhook 请求，然后可能会调用 services 层来处理相应的业务逻辑。
示例: 创建 app/api/webhooks/stripe/route.ts 来处理 Stripe 事件。
总结与决策流程:

问：代码在哪里运行？

服务器端 (Server Component, Server Action)? -> 倾向于直接调用 services 层。
客户端 (Client Component)? -> 倾向于调用 app/api 路由。
外部系统? -> 必须使用 app/api 路由。
问：目的是什么？

页面初始数据加载 (服务器端)? -> services 层。
表单提交/数据变更 (由 Action 处理)? -> services 层。
客户端交互式数据获取/更新? -> app/api 路由。
提供公共 API / 接收 Webhook? -> app/api 路由。
记住，services 层是封装核心业务逻辑和与数据源交互的地方。而 app/api 路由是提供HTTP 接口的一种方式。当你需要 HTTP 接口时（主要是为了客户端或外部系统），就使用 app/api；当你的服务器端代码可以直接执行业务逻辑时，就直接调用 services。